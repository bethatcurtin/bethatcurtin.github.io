<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Text-to-Image Playground</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="./styles/image_playground.css">
    <link rel="icon" type="image/x-icon" href="../assets/b-profile-pic.png">
</head>

<body>

    <h2>Text-to-Image Generator</h2>
    <div class="window">
        <div class="sidebar section-style">
            <label for="apiKey">fal api key</label>
            <input type="password" id="apiKey" placeholder="654321qwerty" />

            <label for="model">model</label>
            <!-- https://huggingface.co/api/partners/fal-ai/models -->
            <!-- https://huggingface.co/api/models?inference_provider=fal-ai&pipeline_tag=text-to-image -->
            <select id="model">
                <option value=""></option>
                <option value="AuraFlow-v0.3">AuraFlow-v0.3</option>
                <option value="Sana-Test">Sana Test</option>
                <!--                 <option value="FLUX.1-dev">FLUX.1-dev</option> -->
                <option value="FLUX.1-schnell">FLUX.1-schnell</option>
                <!--                 <option value="HiDream-I1-Dev">HiDream-I1-Dev</option> -->
                <option value="HiDream-I1-Fast">HiDream-I1-Fast</option>
                <!--                 <option value="HiDream-I1-Full">HiDream-I1-Full</option> -->
                <!--                 <option value="stable-diffusion-3.5-large">stable-diffusion-3.5-large</option> -->
                <option value="stable-diffusion-3.5-large-turbo">stable-diffusion-3.5-large-turbo</option>
                <!--                 <option value="stable-diffusion-3.5-medium">stable-diffusion-3.5-medium</option> -->


            </select>
            <!-- <div id="result_model_info"></div> -->
            <div class="toggle_container">
                <p>Show/hide the model info</p>
                <img id="toggle_icon_model_info" class="toggle_img" src="../assets/icons/toggle_off.svg"
                    alt="Toggle view model info" onclick="toggle_model_info()">
                <div id="result_model_info" class="toggle_disp">
                    <pre class="json_format">{}</pre>
                </div>
            </div>

        </div>



        <div class="convo section-style">
            <div id="chat-window">
                <div id="result"></div>
                <div id="loading_div"></div>
                <!-- <div id="result_info"></div> -->
            </div>


<label for="prompt">Prompt:</label>
            <div id="button_container">
                <textarea id="prompt" rows="4" placeholder="A scenic view of mountains during sunset..."></textarea>


                <div>
                    <button onclick="generateImage()">Generate</button>
                    <button onclick="giveExample()">Give me an example</button>
                </div>
            </div>
            <!-- <div class="toggle_container">
                <p>Show/hide the input json</p>
                <img id="toggle_icon_input" class="toggle_img" src="../assets/icons/toggle_off.svg"
                    alt="Toggle view input json" onclick="toggle_input_json()">
                <div id="input" class="toggle_disp">
                    <pre class="json_format">{}</pre>
                </div>
            </div> -->


            <!-- <label for="prompt">prompt:</label>
            <textarea id="prompt" rows="4" placeholder="A scenic view of mountains during sunset..."></textarea>



            <div id="input"></div>
            <button onclick="generateImage()">generate</button> -->


        <!-- </div> -->
    </div>


    <script>

        document.getElementById('model').addEventListener('change', fetchModelInfo);
        



        models_aliases = {
            "AuraFlow-v0.3": {
                "hfId": "fal/AuraFlow-v0.3",
                "providerId": "fal-ai/aura-flow"
            },
            "Sana-Test": {
                "hfId": "fal/sana",
                "providerId": "fal-ai/sana"
            },
            "FLUX.1-dev": {
                "hfId": "black-forest-labs/FLUX.1-dev",
                "providerId": "fal-ai/flux/dev"
            },
            "FLUX.1-schnell": {
                "hfId": "black-forest-labs/FLUX.1-schnell",
                "providerId": "fal-ai/flux/schnell"
            },
            "HiDream-I1-Dev": {
                "hfId": "HiDream-ai/HiDream-I1-Dev",
                "providerId": "fal-ai/hidream-i1-dev"
            },
            "HiDream-I1-Fast": {
                "hfId": "HiDream-ai/HiDream-I1-Fast",
                "providerId": "fal-ai/hidream-i1-fast"
            },
            "HiDream-I1-Full": {
                "hfId": "HiDream-ai/HiDream-I1-Full",
                "providerId": "fal-ai/hidream-i1-full"
            },
            "stable-diffusion-3.5-large": {
                "hfId": "stabilityai/stable-diffusion-3.5-large",
                "providerId": "fal-ai/stable-diffusion-v35-large"
            },
            "stable-diffusion-3.5-large-turbo": {
                "hfId": "stabilityai/stable-diffusion-3.5-large-turbo",
                "providerId": "fal-ai/stable-diffusion-v35-large/turbo"
            },
            "stable-diffusion-3.5-medium": {
                "hfId": "stabilityai/stable-diffusion-3.5-medium",
                "providerId": "fal-ai/stable-diffusion-v35-medium"
            }
        }


document.getElementById("prompt").addEventListener("keydown", logKey);


        let isVisible = false;
        let input_json_visible = false;
        let model_info_visible = false;
        const inputDiv = document.getElementById('input');

        function logKey(e) {
            if (e.code == 'Enter') {
                generateImage()
            }
        }


        // template toggle func
        function toggleElement() {
            const element = document.getElementById("toggle_element");
            const icon = document.getElementById("toggleIcon");

            isVisible = !isVisible;
            element.style.display = isVisible ? "block" : "none";
            icon.src = isVisible ? "../assets/icons/toggle_on.svg" : "../assets/icons/toggle_off.svg";
        }


        // toggle the json input visibility
        function toggle_input_json() {
            const element = document.getElementById("input");
            const icon = document.getElementById("toggle_icon_input");



            input_json_visible = !input_json_visible;
            element.style.display = input_json_visible ? "block" : "none";
            icon.src = input_json_visible ? "../assets/icons/toggle_on.svg" : "../assets/icons/toggle_off.svg";

        }

        // toggle the model info visibility
        function toggle_model_info() {
            const element = document.getElementById("result_model_info");
            const icon = document.getElementById("toggle_icon_model_info");

            model_info_visible = !model_info_visible;
            element.style.display = model_info_visible ? "block" : "none";
            icon.src = model_info_visible ? "../assets/icons/toggle_on.svg" : "../assets/icons/toggle_off.svg";
            fetchModelInfo();
        }

        // gives the user a random example prompt
        async function giveExample() {
            document.getElementById('prompt');
            const prompt_examples_list = await fetch('https://bethatcurtin.github.io/files/image_prompt_examples.json')
            data = await prompt_examples_list.json()

            console.log('Loaded JSON:', data);
            const prompt_list = data.image_prompt_examples;
            console.log('Loaded list:', prompt_list);
            console.log('size:', prompt_list.length);

            const randomNumber = Math.floor(Math.random() * prompt_list.length)
            const randomItem = prompt_list[randomNumber];
            console.log('radnom: ', randomItem)
            document.getElementById("prompt").value = randomItem;
            input_join()
        }




        async function fetchModelInfo() {
            const model = document.getElementById('model').value;
            const hfId = models_aliases[model]?.hfId;
            const providerId = models_aliases[model]?.providerId;

            const resultDiv = document.getElementById('result_model_info');

            if (!model) {
                resultDiv.innerHTML = '';
                return;
            }

            resultDiv.innerHTML = 'Loading...';
            console.log(providerId)
            const info = await return_model_info(providerId)
     

            resultDiv.innerHTML = `<div><h3>Model Information</h3>
<pre><strong>Model Name:</strong> ${hfId}<br>
<strong>Model Info:</strong> ${info.description}<br>
<strong>Inputs:</strong> ${info.inputs}<br>
<strong>Price:</strong> ${info.unit_price} per ${info.unit}</pre></div>`;




            // Define the model ID for AuraFlow
            // const MODEL_ID = 'fal-ai/aura-flow';

            // // Construct the URL to fetch the model's schema
            // const SCHEMA_URL = ``;
            // // https://fal.ai/models/fal-ai/aura-flow/api#schema-input
            // //  https://fal.ai/models/${MODEL_ID}/api#schema-input
            // //  https://api.fal.ai/v1/models/${MODEL_ID}/schema
            // // https://api.fal.ai/v1/models/fal-ai/aura-flow/schema

            // // Function to fetch and log the input schema
            // async function fetchAuraFlowInputSchema() {
            //     const MODEL_ID = 'fal-ai/aura-flow';
            //     try {
            //         const response = await fetch(`https://queue.fal.run/fal-ai/sana/components/schemas/SanaInput`, {
            //             method: 'POST',
            //             headers: {
            //                 'Authorization': `Key ${image_api_key}`,
            //                 'Content-Type': 'application/json'
            //             }
            //         });

            //         if (!response.ok) {
            //             throw new Error(`Error fetching schema: ${response.status} ${response.statusText}`);
            //         }

            //         const schema = await response.json();

            //         console.log(response)
            //         console.log(schema)
            //         console.log(schema.requestId)
            //         console.log('AuraFlow Input Parameters:', schema.input);
            //     } catch (error) {
            //         console.error('Failed to retrieve AuraFlow input schema:', error);
            //     }
            // }

            // // Call the function to fetch and log the schema
            // fetchAuraFlowInputSchema();
        }
        async function return_model_info(model_name) {





            const raw_data = await fetch('https://bethatcurtin.github.io/files/fal_models.json')
                data = await raw_data.json()
               
                    console.log('Loaded JSON:', data);
                    // You can now use data.name, data.version, etc.
                    const model = data[model_name];
                    console.log('Model: ', model)
                    if (model) {
                        return model;
                    } else {
                        throw new Error(`Model "${model_name}" not found.`);
                    }
                
                








        }





















        async function clean_prompt_guardrail(prompt_in) {
            // const openrouter_public_apiKey = BETH_TEXT_KEY
            const openrouter_public_apiKey ="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"

            guardrail_response = {
                input_prompt: prompt_in
            }



            const body_clean_prompt = {
                model: "google/gemma-3-27b-it",
                messages: [
                    {
                        role: "system",
                        content: "You are a guardrail in between a user and a text to image generator. You'll be given a Prompt to review and complete the following steps. Only output what you are explicitly asked to.\n1. Decide: is the prompt asking to generate something that might show material which is NOT suitable for under 18 year olds? Unsuitable topics include nsfw, nudity, violence, gore, horror, death, blood and so on.\n2. If the prompt is NOT suitable: a. Can you re-write it to remove the unsuitable elements? If so, rewrite the prompt and output the new version and nothing else. b. If you cannot rewrite it to remove the unsuitable elements, output 'This doesn't look like an appropriate prompt. Try generating something different.' and nothing else.\n3. If the prompt IS suitable: output the original prompt and nothing else."
                    },
                    {
                        role: "user",
                        content: prompt_in
                    }
                ]
            }

            const response = await fetch(`https://openrouter.ai/api/v1/chat/completions`, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${openrouter_public_apiKey}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(body_clean_prompt)

            });
            console.log(response);

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Error generating response");

            }
            const result = await response.json();
            console.log(result);
            const clean_prompt = result.choices[0].message.content;
            guardrail_response.output = clean_prompt

            if (prompt_in == clean_prompt) {
                guardrail_response.action = false
            }
            else if (clean_prompt.includes("doesn't look") && clean_prompt.includes("appropriate") && clean_prompt.includes("something different")) {
                guardrail_response.action = "rewrite"
            } else {
                guardrail_response.action = ""
            }
            console.log(guardrail_response)
            return guardrail_response
        }

        async function generateImage() {
         const apiKey = document.getElementById("apiKey").value.trim();
         

            const model = document.getElementById("model").value;
            const prompt_init = document.getElementById("prompt").value;
            const providerId = models_aliases[model]?.providerId;

            const resultDiv = document.getElementById("result");
            // const resultInfo = document.getElementById("result_info");
            const loadingDiv = document.getElementById("loading_div");

            loadingDiv.innerHTML = `<p><br>Generating image...</p><img src="../assets/icons/spinner-ring.svg">`;

            if (!apiKey || !prompt_init || !model) {
                resultDiv.innerHTML = "All fields are required.";
                loadingDiv.innerHTML = "";

                return;
            }

            const guardrail = await clean_prompt_guardrail(prompt_init)

            prompt = guardrail.output

            console.log(prompt)
            if (prompt != "This doesn't look like an appropriate prompt. Try generating something different.") {

                try {


                    const response = await fetch(`https://fal.run/${providerId}`, {
                        method: "POST",
                        headers: {
                            "Authorization": `Key ${apiKey}`,
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            sync_mode: true,
                            enable_safety_checker: true,
                            prompt: prompt,
                            negative_prompt: "nsfw, violence, gore, horror, death, nudity, blood",
                        })
                    });

                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || "Error generating image");
                    }
                    result = await response.json();


                    console.log(result);
                    console.log(result.data);


                    console.log(result)
                    loadingDiv.innerHTML = "";
                    // const imageURL = URL.createObjectURL(result);
                    const imageURL = result.images[0].url;
                    const height = result.images[0].height;
                    const width = result.images[0].width;
                    const content_type = result.images[0].content_type;
                    const prompt_data = result.prompt;
                    const newResult = document.createElement('div');

                    if (!guardrail.action) {
                        newResult.innerHTML = `<img src="${imageURL}" alt="Generated image" />
<pre>Result Info
Size (w x h): ${width} x ${height}
Input Prompt: "${prompt_init}"
Model's Prompt: "${prompt_data}"
Model: ${model}</pre>`;
                    } else {
                        newResult.innerHTML = `
                         <img src="${imageURL}" alt="Generated image" />
<pre>Result Info
Size (w x h): ${width} x ${height}
Input Prompt: "${prompt_init}"
Guardrail Activated: "${guardrail.action}"
Processed Prompt: "${prompt}"
Model's Prompt: "${prompt_data}"
Model: ${model}</pre>`;
                    }

                    resultDiv.appendChild(newResult);

                    const chatWindow = document.getElementById('chat-window');
                    chatWindow.scrollTop = chatWindow.scrollHeight;





                    return result;
                } catch (error) {
                    
                    newResult.innerHTML = `<p style="color: red;">Error: ${error.message}<br>Prompt: "${prompt}</p>`;
                    resultDiv.appendChild(newResult);

                    const chatWindow = document.getElementById('chat-window');
                    chatWindow.scrollTop = chatWindow.scrollHeight;

                }
            } else {
                loadingDiv.innerHTML = "";
                const newResult = document.createElement('div');
                newResult.innerHTML = `<p style="color: red;">Error: ${prompt}<br>Prompt: "${prompt_init}"</p>`
                resultDiv.appendChild(newResult);
                return;
            }
        }
        
    </script>

</body>

</html>
